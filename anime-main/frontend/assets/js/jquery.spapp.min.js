(function($) {
  $.spapp = function(options) {
    var defaultOptions = {
      defaultView: $("main#spapp > section:last-child").attr("id"),
      templateDir: "./views/",
      pageNotFound: "error_404"
    };
    var settings = $.extend(defaultOptions, options);
    var app = {};
    var routes = {};

    app.route = function(options) {
      $.extend(routes, { [options.view]: options });
    };

    app.run = function() {
      window.addEventListener("hashchange", function() {
        var hash = window.location.hash;
        if (hash.length === 0) { hash = "#" + settings.defaultView; }
        
        var separatorIndex = hash.indexOf('?');
        var viewName = (separatorIndex !== -1) ? hash.substring(1, separatorIndex) : hash.substring(1);
        var sectionId = "#" + viewName; 

        var route = routes[viewName];
        if (!route) {
          viewName = settings.pageNotFound;
          sectionId = "#" + viewName;
        }
        
        $(".spapp-view").not(sectionId).hide();
        var $section = $(sectionId);
        
        if ($section.length > 0) {
           if (route && route.load) {
             $section.load(settings.templateDir + route.load, function() {
               if (route.onReady) route.onReady();
             });
           } else {
             if (route && route.onReady) route.onReady();
           }
           $section.show();
        }
      });

      if (!window.location.hash) { window.location.hash = settings.defaultView; }
      else { window.dispatchEvent(new Event("hashchange")); }
    }
    return app;
  };
}(jQuery));